<!DOCTYPE html>
<html>
<head>
  <title>HunterMap App</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }
    .custom-tooltip {
      white-space: pre-line;
    }
    .leaflet-tooltip-own {
      white-space: normal;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="zoom-level" style="position: absolute; top: 10px; right: 10px; background: white; padding: 4px 8px; border: 1px solid #ccc; font-size: 14px; z-index: 1000;">
    Zoom: 10
  </div>
  <div id="marker-form" style="display: none; position: absolute; top: 100px; right: 10px; background: white; padding: 8px; border: 1px solid #ccc; z-index: 1000; font-size: 13px; line-height: 1.4; max-width: 220px;">
    <div style="font-weight: bold; margin-bottom: 6px;">æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ </div>
    <label for="form-marker-type">ç¨®é¡:</label>
    <select id="form-marker-type">
      <option value="kukuri">ããã‚Šç½ </option>
      <option value="hako">ç®±ç½ </option>
      <option value="koya">å°å±‹</option>
      <option value="parking">é§è»Šå ´</option>
    </select><br>
    <div id="kukuri-prefix-container" style="display: none;">
      <label for="kukuri-prefix">ã‚¨ãƒªã‚¢:</label>
      <select id="kukuri-prefix">
        <option value="" disabled selected>ã‚¨ãƒªã‚¢ã‚’é¸æŠ</option>
      </select><br>
    </div>
    <label for="form-marker-name">åå‰:</label>
    <input type="text" id="form-marker-name" placeholder="ãƒãƒ¼ã‚«ãƒ¼å">
    <select id="kukuri-number" style="display: none;">
      <option value="">ç•ªå·ã‚’é¸æŠ</option>
      <!-- 1ã€œ50ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ -->
      <script>
        document.currentScript.parentElement.innerHTML += Array.from({ length: 50 }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
      </script>
    </select>
    <div id="member-selector-container" style="display: block;">
      <label for="form-member-name">è¨­ç½®è€…:</label>
      <select id="form-member-name">
        <option value="" disabled selected>ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
      </select><br>
    </div>
    <br>
    <button id="add-marker-btn">è¿½åŠ </button>
    <button id="cancel-marker-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
  <button id="locate-btn" style="position: absolute; top: 10px; left: 10px; z-index: 1000; padding: 6px 12px; background: white; border: 1px solid #ccc; font-size: 14px;">
    ğŸ“ ç¾åœ¨åœ°ã¸ç§»å‹•
  </button>
  <button id="marker-list-btn" style="position: absolute; top: 50px; left: 10px; z-index: 1000; padding: 6px 12px; background: white; border: 1px solid #ccc; font-size: 14px;">
    ğŸ“‹ ãƒãƒ¼ã‚«ãƒ¼ä¸€è¦§
  </button>
  <button id="add-area-btn" style="position: absolute; top: 90px; right: 10px; z-index: 1000; padding: 6px 12px; background: white; border: 1px solid #ccc; font-size: 14px;">
    â• ã‚¨ãƒªã‚¢è¿½åŠ 
  </button>
  <button id="add-member-btn" style="position: absolute; top: 130px; right: 10px; z-index: 1000; padding: 6px 12px; background: white; border: 1px solid #ccc; font-size: 14px;">
    â• ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
  </button>
  <div id="marker-list" style="display: none; position: absolute; top: 90px; left: 10px; background: white; border: 1px solid #ccc; padding: 10px; z-index: 1000; max-height: 200px; overflow-y: auto; font-size: 14px; width: 200px;">
  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // ã‚ãªãŸã® Firebase è¨­å®šã‚’ã“ã“ã«è²¼ã£ã¦ãã ã•ã„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAihmg-dRPDidgRZHoM7khibpl3lbPmoag",
    authDomain: "huntermap-app-f002f.firebaseapp.com",
    projectId: "huntermap-app-f002f",
    storageBucket: "huntermap-app-f002f.appspot.com",
    messagingSenderId: "251339203495",
    appId: "1:251339203495:web:5d763826e07de1333a4c82"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
  const membersList = [];
  const memberSnapshot = await getDocs(collection(db, "members"));
  memberSnapshot.forEach((doc) => membersList.push(doc.data().name));
  const memberSelect = document.getElementById("form-member-name");
  if (memberSelect) {
    // ä¸€åº¦ã‚¯ãƒªã‚¢
    memberSelect.innerHTML = '<option value="" disabled selected>ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>';
    membersList.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      memberSelect.appendChild(option);
    });
  }
  const map = L.map('map', { maxZoom: 22 }).setView([35.6895, 139.6917], 10);

  const markerIcons = {
    kukuri: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3539/3539196.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    }),
    hako: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/1018/1018402.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    }),
    koya: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/11522/11522815.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    }),
    parking: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3420/3420275.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    })
  };

  const defaultIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    shadowSize: [41, 41]
  });

  map.locate({ setView: true, maxZoom: 16 });

map.on('locationfound', function(e) {
  const radius = e.accuracy / 2;

  const currentLocationMarker = L.marker(e.latlng, {
    icon: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2922/2922510.png',
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -36]
    })
  }).addTo(map)
    .bindPopup("ç¾åœ¨åœ°ï¼ˆç²¾åº¦: " + radius.toFixed(0) + "mï¼‰").openPopup();

  currentLocationMarker.on('click', () => {
    // èª¬æ˜æ–‡ã‚’ç¾åœ¨åœ°ç”¨ã«å¤‰æ›´
    document.querySelector("#marker-form div").textContent = "ç¾åœ¨åœ°ã«æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ";
    pendingLatLng = currentLocationMarker.getLatLng();
    const point = map.latLngToContainerPoint(pendingLatLng);
    const form = document.getElementById("marker-form");
    form.style.left = `${point.x}px`;
    form.style.top = `${point.y}px`;
    form.style.display = "block";
  });

  L.circle(e.latlng, radius).addTo(map);
});

  map.on('locationerror', function() {
    alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
  });

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: 'Â© OpenStreetMap Â© CARTO',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(map);

// Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿ ï¼‹ å‰Šé™¤ãƒ»ç·¨é›†ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
const querySnapshot = await getDocs(collection(db, "markers"));
const markersMap = new Map();
const markerListBtn = document.getElementById("marker-list-btn");
const markerListDiv = document.getElementById("marker-list");

markerListBtn.addEventListener("click", () => {
  markerListDiv.style.display = markerListDiv.style.display === "none" ? "block" : "none";
});

// ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ å¾Œã‚„èª­ã¿è¾¼ã¿æ™‚ã«ã€ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚’Mapã«ç™»éŒ²ã—ã€ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
function registerMarkerToList(docId, name, latlng, marker) {
  markersMap.set(docId, marker);

  const item = document.createElement("div");
  item.textContent = name;
  item.style.cursor = "pointer";
  item.style.marginBottom = "4px";
  item.onclick = () => {
    map.setView(latlng, 18);
    markerListDiv.style.display = "none";
    // marker.openPopup(); // ä¸€è¦§ã‹ã‚‰ã®ã‚¸ãƒ£ãƒ³ãƒ—ã§ã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã‹ãªã„
  };
  markerListDiv.appendChild(item);
}

querySnapshot.forEach((docSnap) => {
  const data = docSnap.data();
  const icon = markerIcons[data.type] || defaultIcon;
  const marker = L.marker([data.lat, data.lng], { icon }).addTo(map);
  // å¹ãå‡ºã—ã®ä¸­ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒœã‚¿ãƒ³IDã‚’å‰²ã‚Šå½“ã¦
  const btnId = `delete-btn-${docSnap.id}`;
  const editBtnId = `edit-btn-${docSnap.id}`;
  marker.bindPopup(`
    <b id="marker-name-${docSnap.id}">${data.name}</b><br>
    <small>GPS: ${data.lat.toFixed(6)}, ${data.lng.toFixed(6)}</small><br>
    ${data.memo ? `<div><small>ğŸ“ ${data.memo}</small></div>` : ""}
    ${data.member ? `<div><small>è¨­ç½®è€…: ${data.member}</small></div>` : ""}
    <a href="https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lng}" target="_blank">ğŸ“ åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ã</a><br>
    <button id="${editBtnId}">âœï¸ ç·¨é›†</button>
    <button id="${btnId}">ğŸ—‘ å‰Šé™¤</button>
  `);
  // åå‰ã¨ãƒ¡ãƒ¢ã‚’åŒæ™‚ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆæ”¹è¡Œã¯<br>ã§è¡¨ç¾ã—ã€HTMLæœ‰åŠ¹åŒ–ï¼‰
  const tooltipText = data.memo
    ? `<div class="custom-tooltip"><strong>${data.name}</strong><br>${data.memo}</div>`
    : `<div class="custom-tooltip"><strong>${data.name}</strong></div>`;
  marker.bindTooltip(tooltipText, {
    permanent: false,
    direction: "top",
    className: "leaflet-tooltip-own",
    sticky: true,
    opacity: 0.9
  });
  registerMarkerToList(docSnap.id, data.name, marker.getLatLng(), marker);

  // å¹ãå‡ºã—ãŒé–‹ã‹ã‚ŒãŸã¨ãã«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
  marker.on('popupopen', async () => {
    setTimeout(async () => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.onclick = async () => {
          if (confirm("ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            await deleteDoc(doc(db, "markers", docSnap.id));
            map.removeLayer(marker);
          }
        };
      }
      // ç·¨é›†ãƒœã‚¿ãƒ³ã®å‡¦ç†
      const editBtn = document.getElementById(editBtnId);
      if (editBtn) {
        editBtn.onclick = async () => {
          // æœ€æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Firestoreã‹ã‚‰å–å¾—
          const { getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
          const snap = await getDoc(doc(db, "markers", docSnap.id));
          const currentData = snap.data();
          const popupContent = document.createElement("div");
          popupContent.innerHTML = `
            <label>åå‰:</label><br>
            <input id="edit-name-${docSnap.id}" value="${currentData.name}" style="width: 90%;"><br>
            <label>ãƒ¡ãƒ¢:</label><br>
            <textarea id="edit-memo-${docSnap.id}" rows="3" style="width: 90%;">${currentData.memo || ""}</textarea><br>
            <label>è¨­ç½®è€…:</label><br>
            <select id="edit-member-${docSnap.id}" style="width: 90%;">
            </select><br>
            <button id="save-edit-${docSnap.id}">ä¿å­˜</button>
            <button id="cancel-edit-${docSnap.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
          // ãƒ¡ãƒ³ãƒãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã®é¸æŠè‚¢ã‚’åŸ‹ã‚ã‚‹
          const memberSelectEdit = popupContent.querySelector(`#edit-member-${docSnap.id}`);
          memberSelectEdit.innerHTML = "";
          membersList.forEach(name => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            if (name === currentData.member) opt.selected = true;
            memberSelectEdit.appendChild(opt);
          });
          marker.setPopupContent(popupContent);

          setTimeout(() => {
            document.getElementById(`save-edit-${docSnap.id}`).onclick = async () => {
              const newName = document.getElementById(`edit-name-${docSnap.id}`).value.trim();
              const newMemo = document.getElementById(`edit-memo-${docSnap.id}`).value.trim();
              const updatedMember = document.getElementById(`edit-member-${docSnap.id}`).value;
              const today = new Date();
              const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
              const memoWithDate = newMemo ? `${newMemo}ï¼ˆ${dateStr}ï¼‰` : "";

              await updateDoc(doc(db, "markers", docSnap.id), {
                name: newName,
                memo: memoWithDate,
                member: updatedMember
              });

              marker.setPopupContent(`
                <b id="marker-name-${docSnap.id}">${newName}</b><br>
                <small>GPS: ${currentData.lat.toFixed(6)}, ${currentData.lng.toFixed(6)}</small><br>
                ${memoWithDate ? `<div><small>ğŸ“ ${memoWithDate}</small></div>` : ""}
                ${updatedMember ? `<div><small>è¨­ç½®è€…: ${updatedMember}</small></div>` : ""}
                <a href="https://www.google.com/maps/search/?api=1&query=${currentData.lat},${currentData.lng}" target="_blank">ğŸ“ åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ã</a><br>
                <button id="edit-btn-${docSnap.id}">âœï¸ ç·¨é›†</button>
                <button id="delete-btn-${docSnap.id}">ğŸ—‘ å‰Šé™¤</button>
              `);
              // ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
              marker.closePopup();
            };
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†
            const cancelBtn = document.getElementById(`cancel-edit-${docSnap.id}`);
            if (cancelBtn) {
              cancelBtn.onclick = () => {
                marker.closePopup();
              };
            }
          }, 100);
        };
      }
    }, 100); // 100ãƒŸãƒªç§’å¾Œã«å®Ÿè¡Œ
  });
});

// ã“ã“ã§areasã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã‚¨ãƒªã‚¢æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã€kukuri-prefixã«è¿½åŠ 
const areaSnapshot = await getDocs(collection(db, "areas"));
const areaSelect = document.getElementById("kukuri-prefix");
areaSnapshot.forEach((docSnap) => {
  const areaName = docSnap.data().name;
  // é‡è¤‡ã—ãªã„ã‚ˆã†ã«æ—¢å­˜ã®optionã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰è¿½åŠ 
  if (![...areaSelect.options].some(opt => opt.value === areaName)) {
    const option = document.createElement("option");
    option.value = areaName;
    option.textContent = areaName;
    areaSelect.appendChild(option);
  }
});

let pendingLatLng = null;
map.on('click', function (e) {
  // èª¬æ˜æ–‡ã‚’é€šå¸¸ã®æ–°è¦è¿½åŠ ç”¨ã«å¤‰æ›´
  document.querySelector("#marker-form div").textContent = "æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ ";
  pendingLatLng = e.latlng;
  // ç·¯åº¦çµŒåº¦ã‚’ç”»é¢åº§æ¨™ã«å¤‰æ›ã—ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãã®è¿‘ãã«è¡¨ç¤º
  const point = map.latLngToContainerPoint(e.latlng);
  const form = document.getElementById("marker-form");
  form.style.left = `${point.x}px`;
  form.style.top = `${point.y}px`;
  form.style.display = "block";
});

document.getElementById("form-marker-type").addEventListener("change", () => {
  const type = document.getElementById("form-marker-type").value;
  document.getElementById("kukuri-prefix-container").style.display = type === "kukuri" ? "block" : "none";
  document.getElementById("form-marker-name").style.display = type === "kukuri" ? "none" : "inline-block";
  document.getElementById("kukuri-number").style.display = type === "kukuri" ? "inline-block" : "none";
});

// åˆæœŸé¸æŠçŠ¶æ…‹ã«å¿œã˜ã¦åœ°åå€™è£œã¨åå‰æ¬„/ç•ªå·æ¬„ã‚’è¡¨ç¤º
const initialType = document.getElementById("form-marker-type").value;
document.getElementById("kukuri-prefix-container").style.display = initialType === "kukuri" ? "block" : "none";
document.getElementById("form-marker-name").style.display = initialType === "kukuri" ? "none" : "inline-block";
document.getElementById("kukuri-number").style.display = initialType === "kukuri" ? "inline-block" : "none";

document.getElementById("add-marker-btn").addEventListener("click", async () => {
  const prefix = document.getElementById("kukuri-prefix").value;
  const type = document.getElementById("form-marker-type").value;
  let name = "";
  if (type === "kukuri") {
    const number = document.getElementById("kukuri-number").value;
    if (!number || !pendingLatLng) return;
    name = (prefix ? prefix + " " : "") + number;
  } else {
    name = document.getElementById("form-marker-name").value.trim();
    if (!name || !pendingLatLng) return;
    if (prefix) {
      name = prefix + " " + name;
    }
  }
  const selectedMember = document.getElementById("form-member-name").value;

  const newDoc = await addDoc(collection(db, "markers"), {
    name,
    lat: pendingLatLng.lat,
    lng: pendingLatLng.lng,
    type,
    memo: "",
    member: selectedMember,
    timestamp: new Date()
  });

  const marker = L.marker([pendingLatLng.lat, pendingLatLng.lng], { icon: markerIcons[type] }).addTo(map);
  const btnId = `delete-btn-${newDoc.id}`;
  const editBtnId = `edit-btn-${newDoc.id}`;
  marker.bindPopup(`
    <b id="marker-name-${newDoc.id}">${name}</b><br>
    <small>GPS: ${pendingLatLng.lat.toFixed(6)}, ${pendingLatLng.lng.toFixed(6)}</small><br>
    ${selectedMember ? `<div><small>è¨­ç½®è€…: ${selectedMember}</small></div>` : ""}
    <a href="https://www.google.com/maps/search/?api=1&query=${pendingLatLng.lat},${pendingLatLng.lng}" target="_blank">ğŸ“ åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ã</a><br>
    <button id="${editBtnId}">âœï¸ ç·¨é›†</button>
    <button id="${btnId}">ğŸ—‘ å‰Šé™¤</button>
  `);
  // åå‰ã¨ãƒ¡ãƒ¢ã‚’åŒæ™‚ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤ºï¼ˆæ–°è¦è¿½åŠ æ™‚ã¯ãƒ¡ãƒ¢ãªã—ã€HTMLæœ‰åŠ¹åŒ–ï¼‰
  const tooltipText = `<div class="custom-tooltip"><strong>${name}</strong></div>`;
  marker.bindTooltip(tooltipText, {
    permanent: false,
    direction: "top",
    className: "leaflet-tooltip-own",
    sticky: true,
    opacity: 0.9
  });
  registerMarkerToList(newDoc.id, name, marker.getLatLng(), marker);

  marker.on('popupopen', async () => {
    setTimeout(async () => {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.onclick = async () => {
          if (confirm("ã“ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            await deleteDoc(doc(db, "markers", newDoc.id));
            map.removeLayer(marker);
          }
        };
      }
      const editBtn = document.getElementById(editBtnId);
      if (editBtn) {
        editBtn.onclick = async () => {
          const popupContent = document.createElement("div");
          popupContent.innerHTML = `
            <label>åå‰:</label><br>
            <input id="edit-name-${newDoc.id}" value="${name}" style="width: 90%;"><br>
            <label>ãƒ¡ãƒ¢:</label><br>
            <textarea id="edit-memo-${newDoc.id}" rows="3" style="width: 90%;"></textarea><br>
            <label>è¨­ç½®è€…:</label><br>
            <select id="edit-member-${newDoc.id}" style="width: 90%;">
            </select><br>
            <button id="save-edit-${newDoc.id}">ä¿å­˜</button>
            <button id="cancel-edit-${newDoc.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
          // ãƒ¡ãƒ³ãƒãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã®é¸æŠè‚¢ã‚’åŸ‹ã‚ã‚‹
          const memberSelectEdit = popupContent.querySelector(`#edit-member-${newDoc.id}`);
          memberSelectEdit.innerHTML = "";
          membersList.forEach(n => {
            const opt = document.createElement("option");
            opt.value = n;
            opt.textContent = n;
            if (n === selectedMember) opt.selected = true;
            memberSelectEdit.appendChild(opt);
          });
          marker.setPopupContent(popupContent);

          setTimeout(() => {
            document.getElementById(`save-edit-${newDoc.id}`).onclick = async () => {
              const newName = document.getElementById(`edit-name-${newDoc.id}`).value.trim();
              const newMemo = document.getElementById(`edit-memo-${newDoc.id}`).value.trim();
              const updatedMember = document.getElementById(`edit-member-${newDoc.id}`).value;
              const today = new Date();
              const dateStr = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
              const memoWithDate = newMemo ? `${newMemo}ï¼ˆ${dateStr}ï¼‰` : "";

              await updateDoc(doc(db, "markers", newDoc.id), {
                name: newName,
                memo: memoWithDate,
                member: updatedMember
              });

              marker.setPopupContent(`
                <b id="marker-name-${newDoc.id}">${newName}</b><br>
                <small>GPS: ${pendingLatLng.lat.toFixed(6)}, ${pendingLatLng.lng.toFixed(6)}</small><br>
                ${memoWithDate ? `<div><small>ğŸ“ ${memoWithDate}</small></div>` : ""}
                ${updatedMember ? `<div><small>è¨­ç½®è€…: ${updatedMember}</small></div>` : ""}
                <a href="https://www.google.com/maps/search/?api=1&query=${pendingLatLng.lat},${pendingLatLng.lng}" target="_blank">ğŸ“ åœ°å›³ã‚¢ãƒ—ãƒªã§é–‹ã</a><br>
                <button id="edit-btn-${newDoc.id}">âœï¸ ç·¨é›†</button>
                <button id="delete-btn-${newDoc.id}">ğŸ—‘ å‰Šé™¤</button>
              `);
              // ç·¨é›†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
              marker.closePopup();
            };
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‡¦ç†
            const cancelBtn = document.getElementById(`cancel-edit-${newDoc.id}`);
            if (cancelBtn) {
              cancelBtn.onclick = () => {
                marker.closePopup();
              };
            }
          }, 100);
        };
      }
    }, 100);
  });

  document.getElementById("marker-form").style.display = "none";
  document.getElementById("form-marker-name").value = "";
  document.getElementById("kukuri-prefix").value = "";
  document.getElementById("kukuri-number").value = "";
  document.getElementById("form-member-name").value = "";
});

document.getElementById("cancel-marker-btn").addEventListener("click", () => {
  document.getElementById("marker-form").style.display = "none";
  document.getElementById("form-marker-name").value = "";
  document.getElementById("kukuri-prefix").value = "";
});

  // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã®åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  document.getElementById('zoom-level').textContent = 'Zoom: ' + map.getZoom();
  map.on('zoomend', () => {
    document.getElementById('zoom-level').textContent = 'Zoom: ' + map.getZoom();
  });

document.getElementById("locate-btn").addEventListener("click", () => {
  map.locate({ setView: true, maxZoom: 16 });
});

// ã€Œã‚¨ãƒªã‚¢è¿½åŠ ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.getElementById("add-area-btn").addEventListener("click", async () => {
  const newArea = prompt("è¿½åŠ ã™ã‚‹ã‚¨ãƒªã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
  if (newArea && newArea.trim() !== "") {
    const select = document.getElementById("kukuri-prefix");
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if (![...select.options].some(opt => opt.value === newArea)) {
      const option = document.createElement("option");
      option.value = newArea;
      option.textContent = newArea;
      select.appendChild(option);
      select.value = newArea;
      // Firestoreã«ä¿å­˜
      await setDoc(doc(db, "areas", newArea), { name: newArea });
    } else {
      select.value = newArea;
    }
  }
});

// ã€Œãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
document.getElementById("add-member-btn").addEventListener("click", async () => {
  const newMember = prompt("è¿½åŠ ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã®æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
  if (newMember && newMember.trim() !== "") {
    // Firestoreã«ä¿å­˜
    await setDoc(doc(db, "members", newMember), { name: newMember });
    alert(`ãƒ¡ãƒ³ãƒãƒ¼ã€Œ${newMember}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
  }
});
</script>
</body>
</html>